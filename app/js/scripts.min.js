function formatClass(t){var e;switch(t){case"1":e="Warrior";break;case"2":e="Mage";break;case"3":e="Archer"}return e}function getTemplate(t,e){$.get("templates/"+t+".html",function(t){e(t)})}var NWarrior={};NWarrior.Boxes=function(t,e){this.trigger=t,this.target=e,this.bindEvents()},NWarrior.Boxes.prototype={bindEvents:function(){var t=this,e=$(this.trigger),a=$(".overlay");e.each(function(){var e=$(this).data("target"),r=$(e);$(this).click(function(e){e.preventDefault(),a.addClass("active"),a.click(function(){a.removeClass("active"),r.removeClass("active")}),t.closeAll(),r.addClass("active")})})},closeAll:function(){var t=$(".formbox");t.each(function(){$(this).removeClass("active")})}},NWarrior.Home=function(){this.formsSelector="form",this.menuNotLogged=$(".menu--not-logged"),this.loggedMenu=$(".menu--logged"),this.notLoggedText=$(".not-logged--text"),this.loggedText=$(".logged--text"),this.loggedInfo=$(".logged--info"),this.bindEvents(),this.checkLogin()},NWarrior.Home.prototype={bindEvents:function(){var t=this,e=$(this.formsSelector);e.each(function(){var e=$(this),a=e.data("target"),r=e.find(".formbox__result");e.submit(function(i){var o=$(this).serializeObject();i.preventDefault(),t.validation(a,e,r)||(t.ajaxPOST(a,r,o),t.cleanForms(e,a,r))})}),$(".logout").click(function(){t.logout()}),$(".character__wrapper").on("click",".character",function(t){var e=$(this).data("character-id");window.location.assign("/game.html?characterId="+e)})},validation:function(t,e,a){var r=!1;switch(t){case"users":var i=e.find("[name=signupPassword]").val(),o=e.find("[name=signupRepeatPassword]").val();i!=o&&(a.html("The passwords must be equal!"),r=!0);break;case"characters":var s=e.find(".remaining-stats").html();0!=s&&(a.html("You must distribute all attributes!"),r=!0)}return r},cleanForms:function(t,e){switch(t.find("input[type=text]:not([readonly])").val(""),e){case"characters":t.find(".stats__input").val(5),t.find(".stats__counter").val(10)}},ajaxPOST:function(t,e,a){var r=this,i=$(".loader"),o=config.apiURL+t;i.addClass("active"),a.token=localStorage.getItem("NWarriorToken"),$.ajax({type:"POST",url:o,data:a,success:function(a){if(i.removeClass("active"),a.failedAuth)return r.logout();switch(t){case"users":r.handleSignUp(a,e);break;case"users/login":r.handleLogin(a,e);break;case"characters":r.handleCharacterCreation(a,e)}},error:function(t,e,a){403==e&&r.logout()}})},handleSignUp:function(t,e){e.html(t.message),t.created&&setTimeout(function(){$(".overlay").click(),$('[data-target="#formbox-login"]').click()},500)},handleLogin:function(t,e){e.html(t.message),t.logged&&(setTimeout(function(){$(".overlay").click()},500),this.saveSession(t),this.checkLogin())},saveSession:function(t){localStorage.setItem("NWarriorUserID",t.userId),localStorage.setItem("NWarriorEmail",t.email),localStorage.setItem("NWarriorToken",t.token)},checkLogin:function(){localStorage.getItem("NWarriorToken")?(this.loggedInfo.find("span").html(localStorage.getItem("NWarriorEmail")),this.loggedMenu.show(),this.loggedText.show(),this.loggedInfo.show(),this.menuNotLogged.hide(),this.notLoggedText.hide(),this.setupCharacterCreation(),this.updateCharacterList()):(this.loggedMenu.hide(),this.loggedText.hide(),this.loggedInfo.hide(),this.menuNotLogged.show(),this.notLoggedText.show())},setupCharacterCreation:function(){var t=$('[name="form_create"]'),e=t.find(".stats__group"),a=t.find(".remaining-stats"),r=t.find("[name=characterClass]");r.change(function(){var e=$(this).val();t.find(".create__img img").attr("src","img/classes/"+e+".png")}),e.each(function(){var t=$(this),e=t.find(".stats__btn--plus"),r=t.find(".stats__btn--minus"),i=t.find(".stats__input");e.click(function(t){t.preventDefault();var e=a.html(),r=i.val();e>0&&(r++,i.val(r),e--,a.html(e))}),r.click(function(t){t.preventDefault();var e=a.html(),r=i.val();10>e&&r>5&&(r--,i.val(r),e++,a.html(e))})}),$("[name=userId]").val(localStorage.getItem("NWarriorUserID"))},handleCharacterCreation:function(t,e){e.html(t.message),setTimeout(function(){$(".overlay").click(),$('[data-target="#formbox-select"]').click(),e.html(""),$("[name=characterClass]").val(""),$(".create__img img").attr("src","")},500),this.updateCharacterList()},updateCharacterList:function(){var t=this,e=$(".loader"),a=localStorage.getItem("NWarriorUserID"),r=config.apiURL+"characters/byUser/"+a,i=$(".character__wrapper");e.addClass("active"),$(".character__wrapper > *").remove(),getTemplate("characterSelection",function(a){var o=a,s={};s.token=localStorage.getItem("NWarriorToken"),$.ajax({url:r,type:"get",data:s,success:function(t){if(e.removeClass("active"),t.length)for(var a in t){var r=t[a],s=o;s=s.replace("{Nickname}",r.nickname),s=s.replace("{CharacterClass}",formatClass(r.characterClass)),s=s.replace("{Strength}",r.strength),s=s.replace("{Constitution}",r.constitution),s=s.replace("{Dexterity}",r.dexterity),s=s.replace("{Intelligence}",r.intelligence),s=s.replace("{Charisma}",r.charisma),s=s.replace("{ClassImg}",r.characterClass),i.append('<div class="character" data-character-id="'+r._id+'">'+s+"</div>")}else i.append('<p>No characters found! Press "New Character" to create your first!</p>')},error:function(e,a,r){t.logout()}})})},logout:function(){localStorage.clear(),location.reload()}},$.fn.serializeObject=function(){var t={},e=this.serializeArray();return $.each(e,function(){t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},NWarrior.Character=function(t){this["class"],this.nickname,this.str,this.con,this.dex,this["int"],this.cha,this.hp,this.mana,this.stamina,this.hunger,this.sleep,Phaser.Sprite.call(this,t,t.world.randomX,t.world.randomY,"player"),this.create()},NWarrior.Character.prototype=Object.create(Phaser.Sprite.prototype),NWarrior.Character.prototype.constructor=NWarrior.Character,NWarrior.Character.prototype.create=function(){this.game.add.existing(this),this.frame=1,this.game.physics.arcade.enable(this),this.body.collideWorldBounds=!0,this.game.camera.follow(this),this.cursors=this.game.input.keyboard.createCursorKeys(),gameUtils.walkAnimations(this)},NWarrior.Character.prototype.update=function(){gameUtils.walkCursors(this.cursors,this)},NWarrior.Enemy=function(t){this.type,this.str,this.con,this.dex,this["int"],this.cha,this.hp,this.mana,this.stamina,this.hunger,this.sleep,Phaser.Sprite.call(this,t,t.world.randomX,t.world.randomY,"Enemy"),this.create()},NWarrior.Enemy.prototype=Object.create(Phaser.Sprite.prototype),NWarrior.Enemy.prototype.constructor=NWarrior.Enemy,NWarrior.Enemy.prototype.create=function(){},NWarrior.game=function(){this.init()},NWarrior.game.prototype={init:function(){localStorage.getItem("NWarriorToken")||window.location.assign("/");var t=$(".game__wrapper").width(),e=window.innerHeight;NWarrior.game=new Phaser.Game(t,e,Phaser.AUTO,"phaser"),NWarrior.game.state.add("Boot",NWarrior.Boot),NWarrior.game.state.add("Game",NWarrior.Game),NWarrior.game.state.start("Boot"),this.loadCharacterInfo()},loadCharacterInfo:function(){var t=$(".loader"),e=localStorage.getItem("NWarriorUserID"),a=(config.apiURL+"character/"+e,window.location.search.replace("?characterId=","")),r=$(".stats__wrapper");getTemplate("characterStats",function(e){var i=e,o={};o.token=localStorage.getItem("NWarriorToken"),$.ajax({url:config.apiURL+"characters/"+a,type:"get",data:o,success:function(e){t.removeClass("active");var a=i;a=a.replace("{Nickname}",e.nickname),a=a.replace("{Class}",formatClass(e.characterClass)),a=a.replace("{Strength}",e.strength),a=a.replace("{Constitution}",e.constitution),a=a.replace("{Dexterity}",e.dexterity),a=a.replace("{Intelligence}",e.intelligence),a=a.replace("{Charisma}",e.charisma),a=a.replace("{Stamina}",e.stamina),a=a.replace("{Sleep}",e.sleep),a=a.replace("{Hunger}",e.hunger),r.append(a)},error:function(t,e,a){window.location.assign("/")}})})}};var gameUtils={walkAnimations:function(t){t.animations.add("down",[1,0,2],10,!0),t.animations.add("left",[4,3,5],10,!0),t.animations.add("right",[7,6,8],10,!0),t.animations.add("up",[10,9,11],10,!0)},walk:function(t,e,a){switch(a=a||50,t){case"down":this.lastFrame=1,e.body.velocity.y=a,e.body.velocity.x=0;break;case"up":this.lastFrame=10,e.body.velocity.y=-a,e.body.velocity.x=0;break;case"left":this.lastFrame=4,e.body.velocity.x=-a,e.body.velocity.y=0;break;case"right":this.lastFrame=7,e.body.velocity.y=0,e.body.velocity.x=a;break;case"stop":e.body.velocity.x=0,e.body.velocity.y=0,e.animations.stop()}e.animations.play(t)},walkCursors:function(t,e,a){var r;a=a||400,r=t.left.isDown?"left":t.right.isDown?"right":t.up.isDown?"up":t.down.isDown?"down":"stop",this.walk(r,e,a)},randomWalk:function(t,e){var a=this,e=e||150;setInterval(function(){var r=Math.floor(5*Math.random())+1;switch(r){case 1:a.walk("down",t,e);break;case 2:a.walk("up",t,e);break;case 3:a.walk("left",t,e);break;case 4:a.walk("right",t,e);break;case 5:a.walk("stop",t,e)}},1e3)}};NWarrior.Hud=function(t){this.game=t,this.create()},NWarrior.Hud.prototype={create:function(){},turnAudio:function(t){1==this.music.mute?this.music.mute=!1:this.music.mute=!0}},NWarrior.Map=function(t){this.game=t,this.create()},NWarrior.Map.prototype={create:function(){this.map=this.game.add.tilemap("sampleMap");var t=this.map.widthInPixels,e=this.map.heightInPixels;this.game.world.setBounds(0,0,t,e),this.map.addTilesetImage("RPGpack_sheet","tiles"),this.ground=this.map.createLayer("ground"),this.ground.resizeWorld(),this.object=this.map.createLayer("object"),this.object.resizeWorld(),this.water=this.map.createLayer("water"),this.water.resizeWorld()}},NWarrior.Npc=function(t){this.type,this.str,this.con,this.dex,this["int"],this.cha,this.hp,this.mana,this.stamina,this.hunger,this.sleep,Phaser.Sprite.call(this,t,t.world.randomX,t.world.randomY,"npc"),this.create()},NWarrior.Npc.prototype=Object.create(Phaser.Sprite.prototype),NWarrior.Npc.prototype.constructor=NWarrior.Character,NWarrior.Npc.prototype.create=function(){this.game.add.existing(this),this.game.physics.arcade.enable(this),this.body.collideWorldBounds=!0,this.frame=4,this.enableBody=!0,gameUtils.walkAnimations(this),gameUtils.randomWalk(this,50)},NWarrior.Npc.prototype.update=function(){},NWarrior.Boot=function(){},NWarrior.Boot.prototype={preload:function(){this.loadingStyle={font:"18px Helvetica",fill:"#fff"},this.loading=this.game.add.text(this.game.world.centerX,this.game.world.centerY,"Carregando...",this.loadingStyle),this.loading.anchor.setTo(.5),this.game.load.spritesheet("player","img/char2.png",31,32),this.game.load.spritesheet("npc","img/char3.png",31,32),this.game.load.tilemap("sampleMap","tiles/sample_map.json",null,Phaser.Tilemap.TILED_JSON),this.game.load.image("tiles","tiles/RPGpack_sheet.png"),this.game.load.audio("backgroundMusic","audio/RetroMystic.ogg"),this.game.load.image("settings","img/wrench.png"),this.game.load.image("audio","img/audioOn.png")},create:function(){NWarrior.game.state.start("Game")}},NWarrior.Game=function(){this.npcsNumber=10},NWarrior.Game.prototype={create:function(){this.game.time.advancedTiming=!0,this.map=new NWarrior.Map(this.game),this.game.stage.backgroundColor="#00CC66",this.player=new NWarrior.Character(this.game),this.npcs=[],this.npcsGroup=this.game.add.group();for(var t=0;t<this.npcsNumber;t++)this.npcs[t]=new NWarrior.Npc(this.game),this.npcsGroup.add(this.npcs[t]);this.hud=new NWarrior.Hud(this.game)},update:function(){this.game.physics.arcade.collide(this.player,this.npcsGroup)},render:function(){this.game.debug.text(this.game.time.fps||"--",10,640,"#000")}};